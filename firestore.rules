rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if update is only modifying allowed stat fields
    function isStatUpdate() {
      let allowedFields = ['fullness', 'happiness', 'cleanliness', 'energy', 'xp', 'updatedAt', 'stage', 'ageInYears', 'lastAgeCheck'];
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      // Check that all affected keys are in the allowed list
      return affectedKeys.hasOnly(allowedFields) && 
             // Ensure critical fields don't change
             request.resource.data.userId == resource.data.userId &&
             // Check shareableId doesn't change (or doesn't exist in both)
             (!('shareableId' in resource.data) || request.resource.data.shareableId == resource.data.shareableId);
    }
    
    // Pets collection rules
    match /pets/{petId} {
      // Allow authenticated users to read any pet (needed for play dates)
      // Allow unauthenticated users to read pets that have sharing enabled (for shared pet view)
      allow get: if isAuthenticated() || (resource.data.sharingEnabled == true);
      
      // Allow queries for authenticated users (to see all pets for play dates)
      // Allow queries for anyone on shared pets
      allow list: if isAuthenticated() || 
                     request.query.limit <= 1;
      
      // Allow users to create pets with their own userId
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own pets (full access)
      // Allow authenticated users to update stats only on any pet (for play dates and shared interactions)
      allow update: if (isAuthenticated() && resource.data.userId == request.auth.uid) ||
                       (isAuthenticated() && isStatUpdate());
      
      // Allow users to delete their own pets
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Pet interactions collection rules (for shared pet interactions and play dates)
    match /petInteractions/{interactionId} {
      // Allow anyone to read interactions
      allow read: if true;
      
      // Allow authenticated users to create interactions (for shared pet feature and play dates)
      allow create: if isAuthenticated();
      
      // Don't allow updates or deletes
      allow update, delete: if false;
    }
    
    // Notifications collection rules
    match /notifications/{notificationId} {
      // Allow users to read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Allow anyone to create notifications (system-generated)
      allow create: if true;
      
      // Allow users to update their own notifications (e.g., mark as read)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Allow users to delete their own notifications
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
