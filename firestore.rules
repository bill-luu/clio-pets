rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Pets collection rules
    match /pets/{petId} {
      // Allow users to read their own pets
      // Also allow anyone to read pets that have sharing enabled (for shared pet view)
      // Note: For queries, we need to allow list access separately
      allow get: if (isAuthenticated() && resource.data.userId == request.auth.uid) ||
                    (resource.data.sharingEnabled == true);
      
      // Allow queries for authenticated users on their own pets
      // Allow queries for anyone on shared pets
      allow list: if isAuthenticated() || 
                     request.query.limit <= 1;
      
      // Allow users to create pets with their own userId
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Allow users to update their own pets
      // Also allow anyone to update shared pets (for stat changes from interactions)
      allow update: if (isAuthenticated() && resource.data.userId == request.auth.uid) ||
                       (resource.data.sharingEnabled == true && 
                        request.resource.data.userId == resource.data.userId &&
                        request.resource.data.shareableId == resource.data.shareableId &&
                        request.resource.data.sharingEnabled == resource.data.sharingEnabled);
      
      // Allow users to delete their own pets
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Pet interactions collection rules (for shared pet interactions)
    match /petInteractions/{interactionId} {
      // Allow anyone to read interactions
      allow read: if true;
      
      // Allow anyone to create interactions (for shared pet feature)
      allow create: if true;
      
      // Don't allow updates or deletes
      allow update, delete: if false;
    }
    
    // Notifications collection rules
    match /notifications/{notificationId} {
      // Allow users to read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Allow anyone to create notifications (system-generated)
      allow create: if true;
      
      // Allow users to update their own notifications (e.g., mark as read)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Allow users to delete their own notifications
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
